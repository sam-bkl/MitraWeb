@{
    Layout = "~/Views/Shared/UserDash/_Layoutdb.cshtml";
    ViewData["Title"] = "DayWiseActivation";
}


@section header {
    <!-- Bootstrap 5 CSS -->

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>

        

        
    
    </style>

}
<div id="app">
    <div class="row">
        <div class="col-12">
            @* header and filter *@

            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3>Billing Status (Not Activated)</h3>
     
                        </div>

                    </div>



                </div>
            </div>
      
            @* table and data *@
            <div class="row">
                <div class="col-12">

                    <div class="card">
                        <div class="card-header">

                        </div>
                        <div class="card-content collapse show">
                            <div class="card-body card-dashboard">

                                <div class="table-responsive " v-if="data.length !== 0">

                                    <div v-if="error" class="error">
                                        {{ error }}
                                    </div>

                                    <div v-if="loading" class="loading">
                                        Loading data...
                                    </div>

                                    <div v-else-if="!loading && data.length === 0" class="no-data">
                                        No data available. Click "Fetch Data" to load activation summary.
                                    </div>
                                        
                                       
                                    <table v-else class="table table-striped table-bordered table-sm small zero-configuration ">
                                        <thead>
                                            <tr>
                                                <th>ACTIVATION_STATUS</th>
                                                <th>ACTIVATION_REMARKS</th>
                                                <th>Counts</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                         
                                            
                                            <tr v-for="(row, index) in GetTotalData" :key="index" >
                                                              
                                                <td class="text-danger fw-bold">{{ row.ACTIVATION_STATUS }}</td>
                                                <td class="text-danger fw-bold">{{ row.ACTIVATION_REMARKS }}</td>
                                                <td class="text-danger fw-bold">{{ row.TOTAL_C_ACTIVATIONS }}
                                                </td>
                                            </tr>
                                            <tr v-for="(row, index) in data" :key="index">
                                                <template v-if="row.ACTIVATION_REMARKS !== 'TOTAL'">
                                                      <td :class = "{'text-danger fw-bold' :  row.ACTIVATION_REMARKS === 'TOTAL'}">{{ row.ACTIVATION_STATUS }}</td>
                                                        <td :class = "{'text-danger fw-bold' :  row.ACTIVATION_REMARKS === 'TOTAL'}">{{ row.ACTIVATION_REMARKS }}</td
                                                        <td :class = "{'text-danger fw-bold' :  row.ACTIVATION_REMARKS === 'TOTAL'}">{{ row.TOTAL_C_ACTIVATIONS }}</td>
                                                </template>
     
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                            </div>
                        </div>

                    </div>



                </div>
            </div>
        </div>
    </div>




</div>



@section Scripts {
    <script>
        const { createApp, ref, reactive, onMounted, computed } = Vue;
  
   createApp({
            setup() {
                const startDate = ref('');
                const endDate = ref('');
                const data = ref([]);
                const loading = ref(false);
                const error = ref('');

                const fetchData = async () => {
                    loading.value = true;
                    error.value = '';
                    
                    try {
                        @* const params = new URLSearchParams();
                        if (startDate.value) params.append('startDate', startDate.value);
                        if (endDate.value) params.append('endDate', endDate.value); *@
                        
                        const url = `/summary/GetBillingStatus`;
                        const response = await fetch(url);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        
                        // Parse the data - adjust this based on your actual API response format
                        // Assuming the API returns an array of objects or raw data
                        console.log(result.data);
                        data.value = result.data;
                        
                    } catch (err) {
                        error.value = `Failed to fetch data: ${err.message}`;
                        console.error('Error fetching data:', err);
                    } finally {
                        loading.value = false;
                    }
                };

                const GetTotalData = computed(() =>{
                    
                    const result = data.value.filter(item =>
                        item.ACTIVATION_REMARKS === 'TOTAL'
                    );

                    return result;
                });
                // Helper function to parse data if needed
                const parseData = (result) => {
                    // If your API returns the data in a different format, adjust this
                    if (result.data && Array.isArray(result.data)) {
                        return result.data;
                    }
                    return [];
                };

                const downloadCSV = () => {
                    if (data.value.length === 0) return;
                    

                    // Create CSV content
                    const headers = [ 'ACTIVATION_STATUS','ACTIVATION_REMARKS', 'TOTAL_C_ACTIVATIONS'];
                    const csvRows = [headers.join(',')];
                    
                    data.value.forEach(row => {
                        const values = [
                            row.onboarding_date,
                            `"${row.circle_name}"`, // Wrap in quotes to handle commas in region names
                            row.counts
                        ];
                        csvRows.push(values.join(','));
                    });
                    
                    const csvContent = csvRows.join('\n');
                    
                    // Create blob and download
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    
                    link.setAttribute('href', url);
                    link.setAttribute('download', `billing_activation_summary_${startDate.value}_to_${endDate.value}.csv`);
                    link.style.visibility = 'hidden';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };
                // Set default dates (last 7 days)
                const today = new Date();
                const weekAgo = new Date(today);
                weekAgo.setDate(weekAgo.getDate() - 7);
                
                endDate.value = today.toISOString().split('T')[0];
                startDate.value = today.toISOString().split('T')[0];
                // Lifecycle hook
                onMounted(() => {
                
                fetchData();

                });
                return {
                    startDate,
                    endDate,
                    data,
                    loading,
                    error,
                    fetchData,
                    downloadCSV,
                    GetTotalData,
                };
            }
        }).mount('#app');
    </script>
}