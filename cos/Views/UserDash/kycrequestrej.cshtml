@{
    Layout = "~/Views/Shared/UserDash/_Layoutdb.cshtml";
    ViewData["Title"] = "Login Page";
}

   
<div class="row">
    <div class="col-lg-3 col-12">
        <div class="card pull-up">
            <div class="card-content">
                <div class="card-body">
                    <div class="media d-flex">
                        <div class="media-body text-left">
                            <h6 class="text-muted">Rejected on verification </h6>
                            <h3 class="kyc-link" data-type="COS" style="cursor:pointer">0</h3><br />
                            <a href="/UserDash/DownloadKycCsv?type=COS" class="text-success">CSV Download</a>
                        </div>
                        <div class="align-self-center">
                            <i class="la la-inbox font-large-2 float-right"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-12">
        <div class="card pull-up">
            <div class="card-content">
                <div class="card-body">
                    <div class="media d-flex">
                        <div class="media-body text-left">
                            <h6 class="text-muted">Rejected while activation </h6>
                            <!-- <h3 id="bcd-cos" style="cursor:pointer;">0</h3> -->
                            <h3 class="kyc-link" data-type="BCD" style="cursor:pointer">0</h3><br />
                            <a href="/UserDash/DownloadKycCsv?type=BCD" class="text-success">CSV Download</a>
                        </div>
                        <div class="align-self-center">
                            <i class="la la-inbox font-large-2 float-right"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title">eKYC Requests (Rejected)</h4>
                <a class="heading-elements-toggle"><i class="la la-ellipsis-v font-medium-3"></i></a>
                <div class="heading-elements">
                    <ul class="list-inline mb-0">
                        <li><a data-action="collapse"><i class="ft-minus"></i></a></li>
                        <li><a data-action="reload"><i class="ft-rotate-cw"></i></a></li>
                        <li><a data-action="expand"><i class="ft-maximize"></i></a></li>
                        <li><a data-action="close"><i class="ft-x"></i></a></li>
                    </ul>
                </div>
            </div>
            
            <div class="card-content collapse show">
                <div class="card-body card-dashboard">
                   
                    <div class="table-responsive">
                        
                        <table id="kycTable" class="table table-striped table-bordered zero-configuration">
                            <thead>
                                <tr>
                                    <th>State</th>
                                    <th>BA code</th>
                                    <th>Name</th>
                                    <th>GSM Number</th>
                                    <th>SIM Number</th>
                                    <th>caf sl NO</th>
                                    <th>Status</th>
                                    <th>Ver Done by</th>
                                    <th>Verification date</th>
                                    <th>Rejection Reason</th>
                                    <th>onboarded by</th>
                                    <th>customer Alt. No</th>
                                    <th>Onboarded Date</th>
                                    <th>Ctopup No</th>
                                </tr>
                            </thead>
                            <tbody id="table-body-kycpend"></tbody>
                        </table>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

  




   
@section Scripts {
    <script>
               
        $(document).ready(function () {
                                GetkycCount();
                                               
        });
        $(document).on('click', '.kyc-link', function () {
            GetkycDetails($(this).data('type'));
        });
        document.getElementById('downloadExcel').addEventListener('click', function () {
            var wb = XLSX.utils.table_to_book(document.getElementById('kycTable'), { sheet: "KYC Rejected" });
            XLSX.writeFile(wb, "KYC_Rejected.xlsx");
        });

        function GetkycCount() {
            $.ajax({
                type: 'GET',
                url: "/UserDash/GetkycstatusrejectedCount",
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                },
                success: function (data) {
                    console.log("KYC counts:", data);

                    // Update the h3 elements using data-type
                    $('.kyc-link').each(function () {
                        const type = $(this).data('type');
                        if (type === 'BCD') $(this).text(data.count2 ?? 0);
                        else if (type === 'COS') $(this).text(data.count1 ?? 0);
                    });
                },
                error: function (xhr, status, error) {
                    console.error("Error fetching KYC counts:", error);
                    console.error("Response:", xhr.responseText);

                    $('.kyc-link').text('0'); // fallback
                }
            });
        }


        function GetkycDetails(item) {

            // Destroy DataTable if already initialized
            if ($.fn.DataTable.isDataTable('#kycTable')) {
                $('#kycTable').DataTable().clear().destroy();
            }

            

            var tableBody = $('#table-body-kycpend');
            tableBody.html('<tr style="text-align:center"><td colspan="9">Loading...</td></tr>');

            $.ajax({
                type: 'POST',
                url: "/UserDash/Getkycstatusrejected",
                data: {
                    type: item
                },
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                },
                success: function (data) {

                    var tableString = '';
                    for (var i = 0; i < data.length; i++) {
                        tableString += '<tr>';
                        tableString += '<td>' + data[i].circle + '</td>';
                        tableString += '<td>' + data[i].ssa_code + '</td>';
                        tableString += '<td>' + data[i].name + '</td>';
                        tableString += '<td>' + data[i].gsmnumber + '</td>';
                        tableString += '<td>' + data[i].simnumber + '</td>';
                        tableString += '<td>' + data[i].cafslno + '</td>';
                        tableString += '<td>' + (data[i].status === 'R' ? 'Rejected' : data[i].status) + '</td>';
                        tableString += '<td>' + data[i].verified_by + '</td>';
                        tableString += '<td>' + data[i].verified_date + '</td>';
                        tableString += '<td>' + data[i].reason + '</td>';
                        tableString += '<td>' + data[i].de_username + ' / ' + data[i].de_csccode + '</td>';
                        tableString += '<td>' + data[i].alternate_contact_no + '</td>';
                        tableString += '<td>' + data[i].live_photo_date + '</td>';
                        tableString += '<td>' + data[i].parent_ctopup_number + '</td>';
                        tableString += '</tr>';
                    }

                    tableBody.html(tableString);

                    $('#kycTable').DataTable({
                        ordering: true,
                        paging: true,
                        searching: true
                    });
                },
                error: function (xhr, status, error) {
                    tableBody.html(
                        '<tr><td colspan="9" style="text-align:center;color:red">' +
                        'Error loading data' +
                        '</td></tr>'
                    );
                    console.error(error);
                }
            });
        }



 // function approveKyc(gsmnumber) {

 //            if (!confirm("Generate CAF for GSM: " + gsmnumber + "?")) {
 //                return;
 //            }

 //            $.ajax({
 //                url: "http://localhost:8000/generate_caf",
 //                type: "POST",
 //                contentType: "application/json",
 //                xhrFields: {
 //                    responseType: 'blob'  // important to handle PDF binary data
 //                },
 //                data: JSON.stringify({
 //                    gsm: gsmnumber
 //                }),
 //                success: function (pdfBlob) {

 //                    // Convert blob to URL
 //                    var pdfUrl = URL.createObjectURL(pdfBlob);

 //                    // Set PDF to iframe
 //                    $("#pdfFrame").attr('src', pdfUrl);

 //                    // Show modal
 //                    $("#pdfModal").modal("show");
 //                },
 //                error: function (xhr) {
 //                    console.error(xhr);
 //                    alert("Failed to generate CAF PDF!");
 //                }
 //            });
 //        }

        var selectedGsmNumber = null;   // Global variable

        function approveKyc(gsmnumber) {

            selectedGsmNumber = gsmnumber; // Save GSM for modal approve button

            console.log("Test Mode: Loading sample.pdf for GSM:", gsmnumber);

            // Load sample PDF
            var pdfUrl = "/sample.pdf";
            $("#pdfFrame").attr("src", pdfUrl);

            // Show popup modal
            $("#pdfModal").modal("show");
        }


                $("#modalApproveBtn").click(function () {

            if (!confirm("Are you sure you want to APPROVE this CAF?")) {
                return;
            }

            $.ajax({
                type: "POST",
                url: "/UserDash/ApproveCAF",   // Your controller endpoint
                data: { gsm: selectedGsmNumber }, // send GSM
                success: function (response) {

                    alert("CAF approved successfully!");

                    $("#pdfModal").modal("hide");  // close modal
                    GetkycDetails();               // reload table
                },
                error: function () {
                    alert("Error approving CAF!");
                }
            });
        });



</script>

}