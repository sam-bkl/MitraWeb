@model cos.ViewModels.LoginVM;
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Login Page";
}

<div class="app-content content">
    <div class="content-header row">
    </div>
    <div class="content-overlay"></div>
    <div class="content-wrapper">
        <div class="content-body">
            <section class="row flexbox-container">
                <div class="col-12 d-flex align-items-center justify-content-center">
                    <div class="col-lg-4 col-md-8 col-10 box-shadow-2 p-0">
                        <div class="card border-grey border-lighten-3 px-1 py-1 m-0">
                            <div class="card-header border-0">
                                <div class="card-title text-center">
                                    <img src="~/images/BSNL_LOGO.jpeg" alt="branding logo" class="img-responsive center-block" style="max-width: 100%; height: auto;">
                                </div>
                                <h3 class="card-subtitle line-on-side  text-center "><span>Customer Onboarding system (COS)</span></h3>
                            </div>
                            <div class="card-content">
                                
                                <div class="card-body">
                                    @if (ViewBag.Error != null && !string.IsNullOrEmpty(ViewBag.Error.ToString()))
                                    {
                                        <div class="alert alert-danger" role="alert">@ViewBag.Error</div>
                                    }
                                    <form class="form-horizontal" asp-action="Login" method="post" autocomplete="off" novalidate>
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" asp-for="otp_sent" value="@Model.otp_sent.ToString().ToLower()" />

                                        @if (!Model.otp_sent)
                                        {
                                            <fieldset class="form-group position-relative has-icon-left">
                                                <input asp-for="username" class="form-control" placeholder="Your Username" required>
                                                <div class="form-control-position">
                                                    <i class="la la-user"></i>
                                                </div>
                                            </fieldset>
                                            <fieldset class="form-group position-relative has-icon-left">
                                                <input asp-for="password" type="password" class="form-control" placeholder="Enter Password" required>
                                                <div class="form-control-position">
                                                    <i class="la la-key"></i>
                                                </div>
                                            </fieldset>
                                            <div class="form-group row">
                                                <div class="col-sm-6 col-12 text-center text-sm-left pr-0">
                                                    <fieldset>
                                                        <input type="checkbox" id="remember-me" class="chk-remember">
                                                        <label for="remember-me"> Remember Me</label>
                                                    </fieldset>
                                                </div>
                                                <div class="col-sm-6 col-12 float-sm-left text-center text-sm-right"><a href="recover-password.html" class="card-link">Forgot Password?</a></div>
                                            </div>

                                            <div class="form-group row">
                                                <div class="col-12">
                                                    <label>Security Code (CAPTCHA)</label>
                                                    <div class="d-flex align-items-center gap-2 mb-2">
                                                        <img src="@Url.Action("CaptchaImage", "Home")" alt="CAPTCHA" id="captchaImg" style="border: 1px solid #ddd; padding: 5px;" />
                                                        <button type="button" class="btn btn-sm btn-warning" onclick="document.getElementById('captchaImg').src='@Url.Action("CaptchaImage", "Home")?' + Math.random();">
                                                            <i class="la la-refresh"></i> Refresh
                                                        </button>
                                                    </div>
                                                    <input asp-for="captcha_input" autocomplete="off" class="form-control" placeholder="Enter CAPTCHA" required />
                                                </div>
                                            </div>

                                            <button type="submit" class="btn btn-outline-info btn-block"><i class="ft-unlock"></i> Sign in</button>
                                        }
                                        else
                                        {
                                            <div class="alert alert-info" role="alert">
                                                <i class="la la-info-circle"></i> OTP has been sent to your registered mobile number. Please enter it below.
                                            </div>
                                            <fieldset class="form-group position-relative has-icon-left">
                                                <input asp-for="otp" class="form-control" placeholder="Enter OTP" autocomplete="off" required maxlength="6" id="otpInput" />
                                                <div class="form-control-position">
                                                    <i class="la la-key"></i>
                                                </div>
                                                <small class="form-text">
                                                    <span id="otpTimer" style="font-weight: bold; color: #4B0082;">OTP is valid for 5:00 minutes</span>
                                                </small>
                                            </fieldset>
                                            <div class="form-group">
                                                <button type="button" onclick="window.location.href='@Url.Action("Index", "Home")'" class="btn btn-link">
                                                    <i class="la la-arrow-left"></i> Back to Login
                                                </button>
                                            </div>
                                            <button type="submit" class="btn btn-outline-info btn-block"><i class="ft-unlock"></i> Verify OTP</button>
                                        }
                                    </form>
                                </div>
                                @* <p class="card-subtitle line-on-side text-muted text-center font-small-3 mx-2 my-1">
                                    <span>
                                        New to Modern
                                        ?
                                    </span>
                                </p>
                                <div class="card-body">
                                    <a href="register-with-bg-image.html" class="btn btn-outline-danger btn-block">
                                        <i class="la la-user"></i>
                                        Register
                                    </a>
                                </div> *@
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </div>
</div>

@section Scripts {
    @if (Model.otp_sent)
    {
        <script>
            (function() {
                const timerElement = document.getElementById('otpTimer');
                const otpInput = document.getElementById('otpInput');
                const submitButton = document.querySelector('button[type="submit"]');
                let timerInterval;

                // Calculate remaining time based on server OTP time
                function calculateRemainingTime() {
                    @if (ViewBag.OtpTime != null)
                    {
                        <text>
                        const otpTimeStr = '@ViewBag.OtpTime';
                        const otpTime = new Date(otpTimeStr);
                        const now = new Date();
                        const elapsedSeconds = Math.floor((now - otpTime) / 1000);
                        const totalSeconds = 300; // 5 minutes
                        const remainingSeconds = Math.max(0, totalSeconds - elapsedSeconds);
                        return remainingSeconds;
                        </text>
                    }
                    else
                    {
                        <text>
                        // Fallback: start from 5 minutes if server time not available
                        return 300;
                        </text>
                    }
                }

                let timeLeft = calculateRemainingTime();

                function updateTimer() {
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    const formattedTime = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
                    
                    if (timeLeft > 0) {
                        timerElement.textContent = 'OTP expires in ' + formattedTime;
                        timerElement.style.fontWeight = 'bold';
                        timerElement.style.color = '#4B0082'; // Indigo color
                        timeLeft--;
                    } else {
                        // Timer expired
                        clearInterval(timerInterval);
                        timerElement.textContent = 'OTP has expired. Please login again.';
                        timerElement.className = 'form-text text-danger font-weight-bold';
                        if (otpInput) {
                            otpInput.disabled = true;
                            otpInput.placeholder = 'OTP Expired';
                        }
                        if (submitButton) {
                            submitButton.disabled = true;
                            submitButton.innerHTML = '<i class="ft-lock"></i> OTP Expired';
                            submitButton.className = 'btn btn-outline-danger btn-block';
                        }
                    }
                }

                // Start the countdown timer
                if (timerElement) {
                    updateTimer(); // Initial call
                    timerInterval = setInterval(updateTimer, 1000); // Update every second
                }

                // Clean up interval when page is unloaded
                window.addEventListener('beforeunload', function() {
                    if (timerInterval) {
                        clearInterval(timerInterval);
                    }
                });
            })();
        </script>
    }
}
